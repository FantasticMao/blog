<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <title>&lt;Unix 环境高级编程&gt; 谈及的几种 IO 模型 | FantasticMao 个人博客</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=0.7">
<meta name="author" content="fantasticmao">
<meta name="description" content="本篇文章记录自己在阅读 《Unix 环境高级编程》 时候，关于书中谈及的几种 IO 模型的一些笔记。">

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="&lt;Unix 环境高级编程&gt; 谈及的几种 IO 模型"/>
<meta name="twitter:description" content="本篇文章记录自己在阅读 《Unix 环境高级编程》 时候，关于书中谈及的几种 IO 模型的一些笔记。"/>

<meta property="og:title" content="&lt;Unix 环境高级编程&gt; 谈及的几种 IO 模型" />
<meta property="og:description" content="本篇文章记录自己在阅读 《Unix 环境高级编程》 时候，关于书中谈及的几种 IO 模型的一些笔记。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.fantasticmao.cn/tech/io-models-mentioned-in-apue/" /><meta property="article:section" content="tech" />
<meta property="article:published_time" content="2020-11-18T11:14:00+08:00" />
<meta property="article:modified_time" content="2020-11-18T11:14:00+08:00" />


<link rel="stylesheet" href="/css/theme.min.c08528059aed0d09aadf3a99f359981364dc2449786343d903cc711a163b7131.css"><link rel="stylesheet" href="/css/emgithub.min.6e0886396003b69922ec0639aa41406d041dd2bba359241b268f02a27eb4e78c.css">

<link rel="stylesheet" href="/css/custom.min.602fd534bd7c46f70cd7a28744b0da1749115c8eb9bd0ba96deac00e0dea3195.css">
<link rel="icon" type="image/svg+xml" sizes="any" href="/favicons/favicon.svg">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="manifest" href="/favicons/site.webmanifest">


</head>

<body>
<header>
  <p><strong>FantasticMao 个人博客</strong></p>
  <nav>
    <p><a href="/">首页</a></p>
    <p>|</p>
    <p><a href="/tech">编程</a></p>
    <p>|</p>
    <p><a href="/essay">随笔</a></p>
    <p>|</p>
    <p><a href="/project">项目</a></p>
    <p>|</p>
    <p><a href="/collect">收藏</a></p>
  </nav>
</header>


<main>
  <article>
    <h1 class="title">&lt;Unix 环境高级编程&gt; 谈及的几种 IO 模型</h1>
    <p class="reading-tips">发表于 2020/11/18，阅读时间 1 分钟</p>

    <p>本篇文章记录自己在阅读 <a href="https://book.douban.com/subject/25900403/">《Unix 环境高级编程》</a> 时候，关于书中谈及的几种 IO 模型的一些笔记。</p>
<h2 id="阻塞-io">阻塞 IO</h2>
<p>Unix 系统中的文件 IO 函数 <code>open</code>、<code>read</code>、<code>write</code>，以及标准 IO 库中的函数 <code>getc</code> / <code>putc</code>、<code>fgets</code> / <code>fputs</code>、<code>fread</code> / <code>fwrite</code> 都属于阻塞 IO，这些函数可能会使进程永远阻塞，例如在以下场景时：</p>
<ul>
<li>如果某些文件类型（例如读管道、终端设备、网络代理）的数据并不存在，读操作可能会使调用者永远阻塞；</li>
<li>如果数据不能被相同的文件类型立即接收（例如管道中没有空间、网络流量控制），写操作可能会使调用者永远阻塞。</li>
</ul>
<p>通常会基于「多线程」的方式来避免在单线程中发生阻塞，不过这种方式将会需要处理线程之间的同步工作。</p>
<h2 id="非阻塞-io">非阻塞 IO</h2>
<p>非阻塞 IO 可以使 <code>open</code>、<code>read</code>、<code>write</code> 这类 IO 操作不会永远阻塞，在这类操作无法完成的时候，它会立即给调用者返回一个错误，表示该操作如果继续执行的话将会导致阻塞。</p>
<p>对于一个给定的描述符，有两种方式可以将其指定为非阻塞 IO：</p>
<ol>
<li>对于尚未打开的描述符，可以在调用 <code>open</code> 函数时指定 <code>O_NOBLOCK</code> 标志；</li>
<li>对于已经打开的描述符，可以通过调用 <code>fcntl</code> 函数来添加 <code>O_NOBLOCK</code> 标志。</li>
</ol>
<p>通常会基于「轮询」的方式来使用非阻塞 IO 进行读写，不过这种方式将会消耗额外的 CPU 资源。</p>
<h2 id="io-多路复用">IO 多路复用</h2>
<p>以 telnet 命令为例来讲述多路复用机制的适用场景。首先介绍 telnet 命令的工作机制：</p>
<ol>
<li>本地机器上的 telnet 命令从终端（标准输入）中读取用户的输入，将所读的数据写入到网络连接，然后发送给远程的 telnetd 守护进程；</li>
<li>远程机器上的 telnetd 守护进程会将用户的输入发送给 shell，并且会将 shell 的输出写回到网络连接，然后发送给本地的 telnet 命令；</li>
<li>本地机器上的 telnet 命令从网络连接中读取 shell 的输出，将所读的数据写回到终端（标准输出）。</li>
</ol>
<p><img src="/images/io-models-mentioned-in-apue/telnet.svg" alt="image"></p>
<p>从 telnet 命令的工作机制可以得知，telnet 命令在工作时会有两个输入和两个输出。在实现 telnet 命令时，对于 IO 模型的选择应该考虑以下几点：</p>
<ul>
<li>如果 telnet 命令是运行在单线程中的，那么不能在任意一个输入中使用阻塞 IO，因为这将会导致另一个输入发生阻塞；</li>
<li>如果 telnet 命令是运行在多线程中的，那么可以使两个输入分别运行在两个线程中，但是这样会需要处理线程之间的同步工作；</li>
<li>可以使用非阻塞 IO 来轮询读取两个输入的数据，但是这样会消耗额外的 CPU 资源；</li>
</ul>
<p>对于 telnet 命令的工作机制，一种比较好的实现方式是使用 IO 多路复用。在使用 IO 多路复用的时候，开发者需要先构建一个感兴趣的描述符（通常不止一个）列表，然后调用一个函数，该函数会在列表中某个描述符已经准备好进行 IO 操作时才会返回。用于执行 IO 多路复用的函数有 <code>poll</code>、<code>pselect</code>、<code>select</code>，当从这些函数返回时，进程会被告知哪些描述符已经准备好可以进行 IO 操作。</p>
<h2 id="异步-io">异步 IO</h2>
<p>信号机制提供了一种以异步形式通知某种事件已经发生的方法。由 BSD 和 System V 派生的所有系统都提供了某种形式的异步 IO，支持使用一个信号（在 System V 中是 SIGPOLL，在 BSD 中是 SIGIO）通知进程，对某个描述符所关心的某个事件已经发生。</p>
<p>但是，这些形式的异步 IO 是受限制的：它们不能用在所有的文件类型上，而且只能使用一个信号。因此如果要对一个以上的描述符进行异步 IO 时，那么进程在接收到该信号时不会知道该信号对应了哪一个描述符。</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://book.douban.com/subject/25900403/">《UNIX 环境高级编程》</a>
<ul>
<li>阻塞 IO：第 3 章、第 5 章</li>
<li>非阻塞 IO：第 14.2 章</li>
<li>IO 多路复用：第 14.4 章</li>
<li>异步 IO：第 14.5 章</li>
</ul>
</li>
</ul>
  </article>
</main>
<footer><div class="comments">
  <script>

    let getTheme = window.localStorage && window.localStorage.getItem("colorscheme");
    let themeInParams = 'github-light';

    if (getTheme == null) {
      if (themeInParams !== '' && themeInParams !== 'auto') {
        getTheme = themeInParams;
      } else {
        getTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? "dark" : "light";
      }
    }

    let theme = getTheme === 'dark' ? 'github-dark' : 'github-light';
    let s = document.createElement('script');
    s.src = 'https://utteranc.es/client.js';
    s.setAttribute('repo', 'fantasticmao\/fantasticmao.github.io');
    s.setAttribute('issue-term', 'pathname');
    s.setAttribute('theme', theme);
    s.setAttribute('crossorigin', 'anonymous');
    s.setAttribute('async', '');
    document.querySelector('div.comments').innerHTML = '';
    document.querySelector('div.comments').appendChild(s);

  </script>
</div>
  <section>
    <p><a href="https://github.com/fantasticmao">GitHub</a></p>
    <p>|</p>
    <p><a href="https://twitter.com/fantasticmao">Twitter</a></p>
    <p>|</p>
    <p><a href="https://www.instagram.com/wonderfulmao/">Instagram</a></p>
    <p>|</p>
    <p><a href="https://steamcommunity.com/id/fantasticmao/">Steam</a></p>
    <p>|</p>
    <p><a href="/index.xml">RSS 订阅</a></p>
  </section>
  <section>
    <p>版权所有 © 2024 fantasticmao</p>
    <p>|</p>
    <p>技术支持 <a href="https://gohugo.io/" target="_blank" rel="nofollow">Hugo</a> & <a href="https://github.com/fantasticmao/momo" target="_blank" rel="nofollow">MoMo</a></p>
    <p>|</p>
    <p><a href="https://beian.miit.gov.cn/" target="_blank" rel="nofollow">浙 ICP 备 17009730 号</a></p>
  </section>
</footer>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-FBHKYP5SYE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-FBHKYP5SYE', { 'anonymize_ip': false });
}
</script>

</body>

</html>
